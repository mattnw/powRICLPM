---
title: "À priori power analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{À priori power analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
This vignette details how you can perform an à priori power analysis for the random intercept cross-lagged panel model (RI-CLPM) using the `powRICLPM` package. The goal of this analysis is to get a sample size recommendation to achieve a desired power for detecting a specific effect in the RI-CLPM. For example, you wish to detect a small cross-lagged effect $\gamma_{2}$ (defined here as the causal effect of $x_{1}^{*}$ to $y_{2}^{*}$, where $x_{1}^{*}$ to $y_{2}^{*}$ denote the latent within-unit components of $x_{1}$ and $y_{2}$, respectively) of 0.2 (standardized). The recommended sample size for à priori analyses is preliminary, because typically a small number of replications is used to speed up the analysis. This implies that the results might not have converged to a stable solution yet, and the recommendation must be verified using a sufficiently large number of replications. 

## Preparation 
Before performing the à priori power analysis, you must determine the *simulation conditions* and *population parameter values*. Simulation conditions refer to characteristics of the study design that can impact statistical power. This includes characteristics like the *sample size* and the *number of repeated measures* included in the study. You must decide the number of repeated measures that will be used in the simulations, and the range of sample sizes over which to simulate the power. For our example, we will investigate the power for sample sizes from 200 to 600 (with incremental steps of 50, resulting in 9 *conditions*) for an RI-CLPM with 3 repeated measures. 

Next, you must determine population parameter values for the RI-CLPM. These can be based on previous research, theory, or expert knowledge. This function requires the specification of:

- `ICC`: The proportion of variance at the between-unit level (relative to the total variance).
- `RI_cor`: The correlation between the random intercepts.
- `Phi`: Standardized autoregressive and cross-lagged effects for the within-unit components of the model.
- `wSigma`: Correlations between the within-unit components. 

Details on how to decide on values for these population parameter values can be found in LINK NAAR PAPER. For our example, the parameter values are set to:

```{r preparation}
ICC <- 0.5
RI_cor <- 0.3
Phi <- matrix(c(.4, .1, .2, .3), ncol = 2, byrow = T) # The .2 refers to our standardized cross-lagged effect of interest
wSigma <- matrix(c(1, .3, .3, 1), ncol = 2, byrow = T)
```

## Analysis
To perform the à priori power analysis, use the `powRICLPM()` function. You must provide:

- the desired power level using the `target_power` argument, 
- the parameter of interest in the `parameter` argument (see the "Details" section in the help file of `powRICLPM` for details on the naming conventions used in this function), 
- the range of sample sizes to simulate the power for using the `search_lower`, `search_upper`, and `search_step` arguments, 
- the number of time points for the simulated data using the `time_points` argument, 
- the population values `ICC`, `RI_cor`, `Phi`, and `wSigma`, and
- the number of MCMC replications you want to perform per condition in the `reps` argument (larger values result in more reliable results, but are more computationally intensive, especially when simulating the power for a large range of sample sizes). 

For our example, we would specify:

```{r analysis, eval = F}
output <- powRICLPM(target_power = 0.5,
                    parameter = "wB2~wA1",
                    search_lower = 200,
                    search_upper = 600,
                    search_step = 50,
                    time_points = 3,
                    ICC = ICC,
                    RI_cor = RI_cor, 
                    Phi = Phi,
                    wSigma = wSigma,
                    reps = 30)
```

Optionally, you can specify:

- `cores`: The number of cores to use during the analysis. Executing the analysis using multiple cores can significantly reduce computation time.
- `seed`: An integer to control the starting point of the random number generator. This is important to use if you want to replicate the results.
- `save_path`: A directory to which any (data) files will be written. 

Technical details on the implementation of the analysis can be found in LINK NAAR PAPER. 

## Results
Using the `powRICLPM()` function creates list with the results, upon which we can call the `powRICLPM_summary()` and `powRICLPM_plot()` functions to summarize and visualize the results of our analysis, respectively. `powRICLPM_summary()` displays a textual summary in the console, including characteristics of the powRICLPM analysis and the minimally recommended sample size to get the desired power for our parameter of interest. It also suggests next steps, amongst which validation of the preliminary recommendation and visualization of results. 

The `powRICLPM_plot()` creates a `ggplot2` scatter plot of simulated power over the range of sample sizes. Use the `parameter` argument to display visualize the power for a specific parameter. 

## What's next?
As the results of this à priori power analysis are usually based on a limited number of MCMC replications (to speed up the analysis), these results might be unreliable because they are unlikely to have converged to a stable solution. Therefore, it is important to rerun the analysis specifically for the recommended sample size using a sufficiently large number of replications. What is considered "sufficiently large" depends on the exact analysis, but in practice researchers use at least 1000 replications, and preferably 10000. We recommend to validate the results in what we refer to as a *post hoc* analysis as this leads to more simulation output (bias, average standard error, etc.). More information can be found at ....  
